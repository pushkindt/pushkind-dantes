{% extends 'base.html' %}
{% include 'constants.html' %}

{% block styles %}
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/selectize.js/0.13.3/css/selectize.bootstrap4.min.css"
        integrity="sha512-MMojOrCQrqLg4Iarid2YMYyZ7pzjPeXKRvhW9nZqLo6kPBBTuvNET9DBVWptAo/Q20Fy11EIHM5ig4WlIrJfQw=="
        crossorigin="anonymous"
        referrerpolicy="no-referrer"
    />
{% endblock %}

{% block content %}
    {% include 'components/navigation.html' %}

    <div class="container my-2">
        <div class="row justify-content-end">
            <div class="col-auto">
                <div class="dropdown">
                    <a class="dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                        Действия
                    </a>
                    <ul class="dropdown-menu bg-light">
                        {% if not benchmark.processing %}
                            <li>
                                <form method="POST" action="/benchmark/{{benchmark.id}}/match">
                                    <button type="submit" class="btn btn-link dropdown-item icon-link">
                                        <i class="bi bi-play mb-1"></i>
                                        мэтчинг
                                    </button>
                                </form>
                            </li>
                        {% else %}
                            <li>
                                <span class="dropdown-item disabled icon-link">
                                    <i class="bi bi-play mb-1"></i>
                                    мэтчинг
                                </span>
                            </li>
                        {% endif %}
                        <li>
                            <form method="POST" action="/benchmark/{{benchmark.id}}/update">
                                <button type="submit" class="btn btn-link dropdown-item icon-link">
                                    <i class="bi bi-arrow-clockwise mb-1"></i>
                                    цены
                                </button>
                            </form>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <div class="container bg-white border rounded my-2">
        <h5>Бенчмарк</h5>
        <div class="row fw-bold">
            <div class="col overflow-hidden" data-column="name">
                Название
            </div>
            <div class="col overflow-hidden" data-column="category">
                Категория
            </div>
            <div class="col overflow-hidden" data-column="price">
                Цена {{constants::currency()}} / ед
            </div>
            <div class="col overflow-hidden">
                Описание
            </div>
        </div>
        <div class="row my-1 py-1 border-top">
            <div class="col overflow-hidden">
                <div>
                    {{benchmark.name}}
                </div>
                <div>
                    {{benchmark.sku}}
                </div>
            </div>
            <div class="col overflow-hidden">
                {{benchmark.category}}
            </div>
            <div class="col overflow-hidden">
                <div>
                    {{benchmark.price}}{{constants::currency()}} / {{benchmark.amount}} {{benchmark.units}}
                </div>
            </div>
            <div class="col overflow-hidden text-truncate toggle-text-truncate">
                {{benchmark.description}}
            </div>
        </div>
    </div>

    {% for crawler_products in crawler_products %}
        {% set crawler = crawler_products.0 %}
        {% set products = crawler_products.1 %}
        {% set show_distances = true %}

        <div class="container bg-white border rounded my-2 items">
            <h5>Товары {{crawler.name}}</h5>
            {% include 'components/products.html' %}
        </div>

    {% endfor %}

{% endblock %}
{% block scripts %}
    <script
        src="https://code.jquery.com/jquery-3.7.1.min.js"
        integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo="
        crossorigin="anonymous">
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/selectize.js/0.13.3/js/standalone/selectize.min.js"
        integrity="sha512-pF+DNRwavWMukUv/LyzDyDMn8U2uvqYQdJN0Zvilr6DDo/56xPDZdDoyPDYZRSL4aOKO/FGKXTpzDyQJ8je8Qw=="
        crossorigin="anonymous" referrerpolicy="no-referrer">
    </script>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            enableSorting(".items", ".row.fw-bold" ".product");
            let product_selects = $(".product-select");
            $(".product-select").each(function() {
                const crawler_id = $(this).data("crawler");
                $(this).selectize({
                    valueField: "id",
                    labelField: "name",
                    searchField: ["name", "sku", "category", "description"],
                    render: {
                        option: function(item, escape) {
                            let result = `<div class="border-bottom"><strong>${escape(item.name)} (${escape(item.sku)})</strong>`;
                            result += '</div>';
                            return result
                        }
                    },
                    options: [],
                    load: function(query, callback) {
                        if (!query.length) return callback();
                        $.ajax({
                            url: `/api/v1/products?page=1&crawler_id=${crawler_id}&query=` + encodeURIComponent(query),
                            type: 'GET',
                            error: function() {
                                callback();
                            },
                            success: function(res) {
                                callback(res.slice(0, 20));
                            },
                            xhrFields: {
                                withCredentials: true
                            },
                        });
                    },
                });
            });
        });
    </script>
{% endblock %}